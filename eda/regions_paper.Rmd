---
title: "Analysis Genes from a Review Paper"
output: html_notebook
---

```{r}
library(readxl)
library(pheatmap)
library(xlsx)
library(tidyverse)
library(grid)

glyco <- readRDS("../data/glyco.rds")
glyco2 <- readRDS("../data/glyco_Reactome.rds")
```

# Overview
```{r}
table(glyco$Class)
```

```{r}
tcx <- read_excel("../output/mayo_modified_paper_TCX.xlsx",
                  sheet = 2, range = cell_cols("B:K"), col_names = T)
bm22 <- read_excel("../output/msbb_modified_paper_BM22.xlsx",
                   sheet = 2, range = cell_cols("B:K"), col_names = T)
bm36 <- read_excel("../output/msbb_modified_paper_BM36.xlsx",
                   sheet = 2, range = cell_cols("B:K"), col_names = T)
dpc <- read_excel("../output/rosmap_modified_paper_dorsolateral.xlsx",
                  sheet = 2, range = cell_cols("B:K"), col_names = T)
bm10 <- read_excel("../output/msbb_modified_paper_BM10.xlsx",
                   sheet = 2, range = cell_cols("B:K"), col_names = T)
bm44 <- read_excel("../output/msbb_modified_paper_BM44.xlsx",
                   sheet = 2, range = cell_cols("B:K"), col_names = T)
cbe <- read_excel("../output/mayo_modified_paper_CBE.xlsx",
                  sheet = 2, range = cell_cols("B:K"), col_names = T)

# tcx2 <- read_excel("../output/mayo_modified_reactome+glycolipids_TCX.xlsx",
#                   sheet = 2, range = cell_cols("B:J"), col_names = T)
# tcx_N <- (filter(tcx, Class == "N-Glycan"|Class=="N-glycosylation"))
# tcx2_N <- (filter(tcx2, Class == "N-Glycan"|Class=="N-glycosylation"))
# tcx2_N[is.na(match(tcx2_N$hgnc_symbol, tcx_N$hgnc_symbol)),]
# bm362 <- read_excel("../output/msbb_modified_reactome+glycolipids_BM36.xlsx",
#                    sheet = 2, range = cell_cols("B:J"), col_names = T)
# bm36_N <- (filter(bm36, Class == "N-Glycan"|Class=="N-glycosylation"))
# bm362_N <- (filter(bm362, Class == "N-Glycan"|Class=="N-glycosylation"))
# bm362_N[is.na(match(bm362_N$hgnc_symbol, bm36_N$hgnc_symbol)),]
# bm442 <- read_excel("../output/msbb_modified_reactome+glycolipids_BM44.xlsx",
#                    sheet = 2, range = cell_cols("B:J"), col_names = T)
# bm44_N <- (filter(bm44, Class == "N-Glycan"|Class=="N-glycosylation"))
# bm442_N <- (filter(bm442, Class == "N-Glycan"|Class=="N-glycosylation"))
# bm442_N[is.na(match(bm442_N$hgnc_symbol, bm44_N$hgnc_symbol)),]
# cbe2 <- read_excel("../output/mayo_modified_reactome+glycolipids_CBE.xlsx",
#                    sheet = 2, range = cell_cols("B:J"), col_names = T)
# cbe_N <- (filter(cbe, Class == "N-Glycan"|Class=="N-glycosylation"))
# cbe2_N <- (filter(cbe2, Class == "N-Glycan"|Class=="N-glycosylation"))
# cbe2_N[is.na(match(cbe2_N$hgnc_symbol, cbe_N$hgnc_symbol)),]


regions <- list(tcx, bm22, bm36, bm44,bm10, dpc, cbe)
names(regions) <- c('tcx', 'bm22', 'bm36', 'bm44', 'bm10', 'dpc', 'cbe')
# N-glycan
sapply(regions, function(x)nrow(filter(x, Class == "N-Glycan"|Class=="N-glycosylation")))
# N-glycan enzymes
sapply(regions, function(x)nrow(filter(x, Class == "N-Glycan")))
# N-glycan transporters
sapply(regions, function(x)nrow(filter(x, Class=="N-glycosylation")))
# O-glycan
sapply(regions, function(x)nrow(filter(x, Class == "O-GalNAc")))
# O-glycan non-enzyme
sapply(regions, function(x)nrow(filter(x, Class == "O-glycosylation")))
# glycolipid
sapply(regions, function(x)nrow(filter(x, Class == "Glycolipid")))
# non-emzyme
sapply(regions, function(x)nrow(filter(x, Class == "Glycosphingolipid")))
# elongation, branching
sapply(regions, function(x)nrow(filter(x, Class == "Elongation.branching")))
# Capping
sapply(regions, function(x)nrow(filter(x, Class == "Capping")))

```

```{r}
## Times of apprearance of genes
count_tcx <- select(tcx, c("hgnc_symbol", "logFC", "Class")) %>%
    distinct() %>%
    mutate(region="temporal")
count_bm22 <- select(bm22, c("hgnc_symbol", "logFC", "Class")) %>%
    distinct() %>%
    mutate(region="bm22")
count_bm36 <- select(bm36, c("hgnc_symbol", "logFC", "Class")) %>%
    distinct() %>%
    mutate(region="bm36")
count_dpc <- select(dpc, c("hgnc_symbol", "logFC", "Class")) %>%
    distinct() %>%
    mutate(region="DLPFC")
count_bm10 <- select(bm10, c("hgnc_symbol", "logFC", "Class")) %>%
    distinct() %>%
    mutate(region="bm10")
count_bm44 <- select(bm44, c("hgnc_symbol", "logFC", "Class")) %>%
    distinct() %>%
    mutate(region="bm44")
count_cbe <- select(cbe, c("hgnc_symbol", "logFC", "Class")) %>%
    distinct() %>%
    mutate(region="cerebellum")

count <- rbind(count_tcx, count_bm22, count_bm36, count_dpc, count_bm10, count_bm44) %>%
    filter(Class != "Sulfotransferases")
# Split into N-/O-
count_N <- filter(count, Class=="N-Glycan")
count_O <- filter(count, Class=="O-GalNAc")
count_L <- filter(count, Class=="Glycolipid")
count_E <- filter(count, Class=="Elongation.branching")
count_C <- filter(count, Class=="Capping")
```

```{r}
# count the times a gene present in brain regions
countSummary <- function(x){
    x %>%
        distinct() %>%
        group_by(hgnc_symbol) %>%
        summarise(present=n()) %>%
        arrange(desc(present))
}
# overlapped genes
topGenes <- function(x, count_summary, n_overlapped=1) {
    filter(x, hgnc_symbol %in% filter(count_summary, present>=n_overlapped)$hgnc_symbol) %>% 
        mutate(hgnc_symbol=factor(hgnc_symbol, levels = unique(count_summary$hgnc_symbol))) %>%
        arrange(hgnc_symbol) %>%
        mutate(region = factor(region, levels = c("DLPFC", "bm44", "temporal", "bm36", "bm10", "bm22")),
               direction = factor(ifelse(logFC>0, "up", "down"), levels = c("up", "down")))
}

```

# Genes initiate N-Glycans  

```{r}
# dotplot
plotDot <- function(count_top){
    ggplot(count_top, aes(x = region, fill = direction, y = hgnc_symbol)) +
        geom_dotplot(binaxis = "y", stackdir = "center", dotsize = 2, binwidth = 0.5)+
        theme_bw()
}
## N-glyco
count_N_summary <- countSummary(count_N)
count_N_top <- topGenes(count_N, count_N_summary)
(dot_N <- plotDot(count_N_top))
```
# Genes for N-glycan transporter, accessory components

```{r fig.height=6}
## N-glyco non-glycosyltransferase
count_NN <- filter(count, Class=="N-glycosylation")
count_NN_summary <- countSummary(count_NN)
count_NN_top <- topGenes(count_NN, count_NN_summary, 4)
(dot_NN <- plotDot(count_NN_top))
```

# Genes for O-GalNAc initiation

```{r}
count_O_summary <- countSummary(count_O)
count_O_top <- topGenes(count_O, count_O_summary)
(dot_O <- plotDot(count_O_top))
```

# Genes for O-glycan transporter, accessory components

```{r fig.height=6}
## O-glyco non-glycosyltransferase
count_OO <- filter(count, Class=="O-glycosylation")
count_OO_summary <- countSummary(count_OO)
count_OO_top <- topGenes(count_OO, count_OO_summary)
(dot_OO <- plotDot(count_OO_top))
```

# Genes for glycolipid initiation

```{r}
count_L_summary <- countSummary(count_L)
count_L_top <- topGenes(count_L, count_L_summary)
(dot_L <- plotDot(count_L_top))
```

# Genes for glycolipid transporter, accessory components

```{r fig.height=6}
## glycolipid non-glycosyltransferase
count_l <- filter(count, Class=="Glycosphingolipid")
count_l_summary <- countSummary(count_l)
count_l_top <- topGenes(count_l, count_l_summary)
(dot_l <- plotDot(count_l_top))
```

# Genes for elongation and branching

```{r}
count_E_summary <- countSummary(count_E)
count_E_top <- topGenes(count_E, count_E_summary)
(dot_E <- plotDot(count_E_top))
```

# Genes for capping

```{r}
count_C_summary <- countSummary(count_C)
count_C_top <- topGenes(count_C, count_C_summary)
(dot_C <- plotDot(count_C_top))
```

```{r}
tcx_a <- read_excel("../output/mayo_modified_paper_TCX.xlsx",
                  sheet = 3, range = cell_cols("F:K"), col_names = T)
bm22_a <- read_excel("../output/msbb_modified_paper_BM22.xlsx",
                   sheet = 3, range = cell_cols("F:K"), col_names = T)
bm36_a <- read_excel("../output/msbb_modified_paper_BM36.xlsx",
                   sheet = 3, range = cell_cols("F:K"), col_names = T)
dpc_a <- read_excel("../output/rosmap_modified_paper_dorsolateral.xlsx",
                  sheet = 3, range = cell_cols("F:K"), col_names = T)
bm10_a <- read_excel("../output/msbb_modified_paper_BM10.xlsx",
                   sheet = 3, range = cell_cols("F:K"), col_names = T)
bm44_a <- read_excel("../output/msbb_modified_paper_BM44.xlsx",
                   sheet = 3, range = cell_cols("F:K"), col_names = T)
cbe_a <- read_excel("../output/mayo_modified_paper_CBE.xlsx",
                  sheet = 3, range = cell_cols("F:K"), col_names = T)

df<- left_join(tcx_a, bm22_a, by=c("Name", "Class"), suffix = c(".TCX", ".bm22")) %>%
    left_join(bm36_a, by=c("Name", "Class")) %>%
    left_join(dpc_a, by=c("Name", "Class"), suffix = c(".bm36", ".DLPFC")) %>%
    left_join(bm10_a, by=c("Name", "Class")) %>%
    left_join(bm44_a, by=c("Name", "Class"), suffix = c(".bm10", ".bm44")) %>%
    left_join(cbe_a, by=c("Name", "Class")) 
```

# Genes for N-glycan

7/2 Remove CBE for match the AAIC abstract.

```{r}
# Add lobe info
TL <- textGrob("Temporal lobe", gp=gpar(fontsize=12))
FL <- textGrob("Frontal lobe", gp=gpar(fontsize=12))

p1 <- filter(df, Class=="N-Glycan") %>%
    select(-Class) %>%
    rename(logFC.CBE=logFC, stat.CBE=stat, pval.CBE=pval, padj.CBE=padj) %>%
    pivot_longer(cols = 2:(ncol(df)-1), names_to = c(".value", "region"), names_pattern = "(.*)\\.(.*)") %>%
    rename(hgnc_symbol=Name) %>%
    mutate(region = factor(region, levels = c("DLPFC", "bm44", "bm10", "TCX", "bm36", "bm22", "CBE")),
           # sig = ifelse(padj<0.05, 2, ifelse(pval<0.05, 1, 0)),
           Sig = factor(ifelse(padj<0.05, 2, ifelse(pval<0.05, 1, 0)), labels = c("Not sig", "pval < 0.05", "adj.pval < 0.05")),
           Direction = factor(ifelse(logFC>0, "up", "down"), levels = c("up", "down"))) %>%
    filter(region != "CBE") %>%
    ggplot(aes(x = region, color = Direction, y = hgnc_symbol, size = Sig)) +
    geom_point()+
    scale_color_manual(values = c("#fba31b", "#490d65")) +
    theme_bw()+
    coord_cartesian(xlim=c(1,6), ylim=c(1,26), clip="off") +
    annotate("segment", x = 1, xend = 3, y = -1.5, yend = -1.5) + 
    annotate("segment", x = 4, xend = 6, y = -1.5, yend = -1.5) + 
    annotation_custom(FL,xmin=1,xmax=3,ymin=-2,ymax=-2) +
    annotation_custom(TL,xmin=4,xmax=6,ymin=-2,ymax=-2)
# ggsave("../img/N-glycan_dots.png", p1, width = 6, height = 9, scale = 1)
```

# Genes for elongation and branching

```{r}
p_e <- filter(df, Class=="Elongation.branching") %>%
    select(-Class) %>%
    rename(logFC.CBE=logFC, stat.CBE=stat, pval.CBE=pval, padj.CBE=padj) %>%
    pivot_longer(cols = 2:(ncol(df)-1), names_to = c(".value", "region"), names_pattern = "(.*)\\.(.*)") %>%
    rename(hgnc_symbol=Name) %>%
    mutate(region = factor(region, levels = c("DLPFC", "bm44", "bm10", "TCX", "bm36", "bm22", "CBE")),
           # sig = ifelse(padj<0.05, 2, ifelse(pval<0.05, 1, 0)),
           Sig = factor(ifelse(padj<0.05, 2, ifelse(pval<0.05, 1, 0)), labels = c("Not sig", "pval < 0.05", "adj.pval < 0.05")),
           Direction = factor(ifelse(logFC>0, "up", "down"), levels = c("up", "down"))) %>%
    filter(region != "CBE") %>%
    .[complete.cases(.),] %>%
    ggplot(aes(x = region, color = Direction, y = hgnc_symbol, size = Sig)) +
    geom_point()+
    scale_color_manual(values = c("#fba31b", "#490d65")) +
    theme_bw()+
    coord_cartesian(xlim=c(1,6), ylim=c(1,18), clip="off") +
    annotate("segment", x = 1, xend = 3, y = -2, yend = -2) + 
    annotate("segment", x = 4, xend = 6, y = -2, yend = -2) + 
    annotation_custom(FL,xmin=1,xmax=3,ymin=-2.5,ymax=-2.5) +
    annotation_custom(TL,xmin=4,xmax=6,ymin=-2.5,ymax=-2.5)
```

# Genes for capping
```{r fig.height=6}
p_c <- filter(df, Class=="Capping") %>%
    select(-Class) %>%
    rename(logFC.CBE=logFC, stat.CBE=stat, pval.CBE=pval, padj.CBE=padj) %>%
    pivot_longer(cols = 2:(ncol(df)-1), names_to = c(".value", "region"), names_pattern = "(.*)\\.(.*)") %>%
    rename(hgnc_symbol=Name) %>%
    mutate(region = factor(region, levels = c("DLPFC", "bm44", "bm10", "TCX", "bm36", "bm22", "CBE")),
           # sig = ifelse(padj<0.05, 2, ifelse(pval<0.05, 1, 0)),
           Sig = factor(ifelse(padj<0.05, 2, ifelse(pval<0.05, 1, 0)), labels = c("Not sig", "pval < 0.05", "adj.pval < 0.05")),
           Direction = factor(ifelse(logFC>0, "up", "down"), levels = c("up", "down"))) %>%
    filter(region != "CBE") %>%
    .[complete.cases(.),] %>%
    ggplot(aes(x = region, color = Direction, y = hgnc_symbol, size = Sig)) +
    geom_point()+
    scale_color_manual(values = c("#fba31b", "#490d65")) +
    theme_bw()+
    coord_cartesian(xlim=c(1,6), ylim=c(1,31), clip="off") +
    annotate("segment", x = 1, xend = 3, y = -2, yend = -2) + 
    annotate("segment", x = 4, xend = 6, y = -2, yend = -2) + 
    annotation_custom(FL,xmin=1,xmax=3,ymin=-2.5,ymax=-2.5) +
    annotation_custom(TL,xmin=4,xmax=6,ymin=-2.5,ymax=-2.5)

# capping
# df_C <- filter(df, Class=="Capping") %>%
#     select(-Class) %>%
#     select("Name", starts_with("logFC")) %>%
#     column_to_rownames("Name")

# df_C[df_C<= -max(df_C[!is.na(df_C)])] <- -max(df_C[!is.na(df_C)])
# (p_C <- pheatmap(df_C, color = colorRampPalette(c("navy", "white", "red"))(50), show_rownames = T, show_colnames = T, cluster_cols = T))
```

```{r}
df_C_pval <- filter(df, Class=="Capping") %>%
    select(-Class, -starts_with("stat")) %>%
    column_to_rownames("Name")
df_C_pval[p_C$tree_row$order,] %>%
    signif(digits = 2) %>%
    DT::datatable(list(mode = 'multiple', selected = c(1)))
```
# Gene for type O-GalNAc glycosylation

```{r}
p_o <- filter(df, Class=="O-GalNAc") %>%
    select(-Class) %>%
    rename(logFC.CBE=logFC, stat.CBE=stat, pval.CBE=pval, padj.CBE=padj) %>%
    pivot_longer(cols = 2:(ncol(df)-1), names_to = c(".value", "region"), names_pattern = "(.*)\\.(.*)") %>%
    rename(hgnc_symbol=Name) %>%
    mutate(region = factor(region, levels = c("DLPFC", "bm44", "bm10", "TCX", "bm36", "bm22", "CBE")),
           # sig = ifelse(padj<0.05, 2, ifelse(pval<0.05, 1, 0)),
           Sig = factor(ifelse(padj<0.05, 2, ifelse(pval<0.05, 1, 0)), labels = c("Not sig", "pval < 0.05", "adj.pval < 0.05")),
           Direction = factor(ifelse(logFC>0, "up", "down"), levels = c("up", "down"))) %>%
    filter(region != "CBE") %>%
    .[complete.cases(.),] %>%
    ggplot(aes(x = region, color = Direction, y = hgnc_symbol, size = Sig)) +
    geom_point()+
    scale_color_manual(values = c("#fba31b", "#490d65")) +
    theme_bw()+
    coord_cartesian(xlim=c(1,6), ylim=c(1,23), clip="off") +
    annotate("segment", x = 1, xend = 3, y = -1.5, yend = -1.5) + 
    annotate("segment", x = 4, xend = 6, y = -1.5, yend = -1.5) + 
    annotation_custom(FL,xmin=1,xmax=3,ymin=-2,ymax=-2) +
    annotation_custom(TL,xmin=4,xmax=6,ymin=-2,ymax=-2)

```

Make figure for the AAIC poster

```{r}
library(cowplot)
mylegend <- get_legend(p1+theme(legend.position = "bottom"))
p <- plot_grid(
    p1+theme(legend.position = "none"), 
    p_o+theme(legend.position = "none"), 
    p_c+theme(legend.position = "none"), 
    labels = c("A", "B", "C"), 
    label_size = 12,
    ncol = 3
    # axis = "b"
) %>%
    plot_grid(
        mylegend,
        nrow = 2,
        rel_heights = c(1, .2)
    )
ggsave("../img/dot_points.png", p, width = 8, height = 3, scale = 2)
```

Boxplot for gene expression across multiple brain regions.
```{r}
library(ggpubr)
logcpm_mayo <- readRDS("../data/mayo_normalized_adj.rds")
logcpm_msbb <- readRDS("../data/msbb_normalized_adj.rds")
logcpm <- readRDS("../data/rosmap_normalized_adj.rds")
getPValues <- function(symbol="LRP1"){
    df[grep(symbol, df$Name),] %>%
        select(-Class) %>%
        rename(logFC.CBE=logFC, stat.CBE=stat, pval.CBE=pval, padj.CBE=padj) %>%
        pivot_longer(cols = 2:(ncol(df)-1), names_to = c(".value", "region"), names_pattern = "(.*)\\.(.*)") %>%
        rename(hgnc_symbol=Name) %>%
        mutate(region = factor(region, levels = c("DLPFC", "bm44", "bm10", "TCX", "bm36", "bm22", "CBE"))) %>%
        filter(region != "CBE")
}
# pvals <- getPValues("GALNTL6")
box_regs <- function(symbol="GALNTL6", ADonly=FALSE){
    pvals <- getPValues(symbol)
    ens <- featureNames(logcpm)[logcpm$fdata$hgnc_symbol==symbol]
    dlpfc <- data.frame(
        Region = "DLPFC",
        Diagnosis = logcpm$pdata$diagnosis,
        Logcpm = logcpm$edata[ens,]
    )
    tcx <- data.frame(
        Region = "TCX",
        Diagnosis = logcpm_mayo$TCX$pdata$Diagnosis,
        Logcpm = logcpm_mayo$TCX$edata[ens,]
    ) %>%
        mutate(Diagnosis = sub("Con", "NCI", Diagnosis))
    df <- rbind(dlpfc, tcx)
    for (reg in names(logcpm_msbb)) {
        bm <- data.frame(
            Region = reg,
            Diagnosis = logcpm_msbb[[reg]]$pdata$diagnosis,
            Logcpm = logcpm_msbb[[reg]]$edata[ens,]
        )
        df <- rbind(df,bm)
    }
    if (ADonly) {
        df <- df %>%
            filter(Diagnosis %in% c('NCI', "AD")) %>%
            mutate(Diagnosis = factor(Diagnosis, levels = c("NCI", "AD")))
    } else {
        df <- df %>%
            filter(Diagnosis != "Transition") %>%
            mutate(Diagnosis = factor(Diagnosis, levels = c("NCI", "MCI", "PA", "AD", "PSP", "Other")))
        
    }
    stat.test <- tibble(
        group1 = c(0.7, 1.7, 2.7, 3.7, 4.6, 5.5),
        group2 = c(1.3, 2.3, 3.3, 4.3, 5.1, 6.1),
        p.adj = c(pvals[pvals$region=="bm10",]$padj, pvals[pvals$region=="bm22",]$padj, pvals[pvals$region=="bm36",]$padj, pvals[pvals$region=="bm44",]$padj, pvals[pvals$region=="DLPFC",]$padj, pvals[pvals$region=="TCX",]$padj) 
        )%>%
            signif(digits = 2)
    # print(stat.test)
    ggplot(df, aes(Region, Logcpm, color=Diagnosis))+
        geom_boxplot(aes(color=Diagnosis))+
        geom_point(position = position_jitterdodge(jitter.width = 0.1))+
        theme_bw() +
        scale_color_manual(values = inferno(7))+
        stat_pvalue_manual(
            stat.test,
            y.position = max(df$Logcpm)*1.05, step.increase = 0,
            label = "p.adj"
        )+
        lims(y = c(NA, max(df$Logcpm)*1.1))+
        labs(y = paste0(symbol, " (LogCPM)"))
}
GALNTL6 <- box_regs("GALNTL6")
GALNT17 <- box_regs("GALNT17")
GALNT11 <- box_regs("GALNT11")
ST3GAL3 <- box_regs("ST3GAL3")
ST6GAL2 <- box_regs("ST6GAL2")
```

```{r}
mylegend2 <- get_legend(GALNT11+theme(legend.position = "bottom")+ guides(color=guide_legend(nrow=1,byrow=TRUE)))
p_box <- plot_grid(
    GALNT11+theme(legend.position = "none"), 
    GALNT17+theme(legend.position = "none"), 
    ST6GAL2+theme(legend.position = "none"),
    ST3GAL3+theme(legend.position = "none"),
    # GALNTL6+theme(legend.position = "none", axis.title.x = element_blank(), axis.text.x = element_blank()), 
    labels = c("A", "B", "C", "D"), 
    label_size = 12,
    ncol = 4,
    align = "h"
    # axis = "b"
) %>%
    plot_grid(
        mylegend2,
        nrow = 2,
        rel_heights = c(1, .1)
    )
# p_cbox <- plot_grid(
#     ST6GAL2+theme(legend.position = "none"),
#     ST3GAL3+theme(legend.position = "none"),
#     labels = c("C", "D"), 
#     label_size = 12,
#     ncol = 2,
#     rel_heights = c(1, 1)
# )
# p_box <- plot_grid(
#     p_obox, p_cbox,
#     nrow = 2
# ) %>%
#     plot_grid(
#         mylegend2,
#         ncol = 2,
#         rel_widths = c(1, .2)
#     )
ggsave("../img/boxes.png", p_box, width = 8, height = 1.5, scale = 2)
```

